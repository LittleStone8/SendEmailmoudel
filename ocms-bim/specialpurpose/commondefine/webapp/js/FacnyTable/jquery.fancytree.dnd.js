!function(e,r,t,a){"use strict";function n(e){return 0===e?"":e>0?"+"+e:""+e}function o(){l||(e.ui.plugin.add("draggable","connectToFancytree",{start:function(r,t){var a=e(this).data("ui-draggable")||e(this).data("draggable"),n=t.helper.data("ftSourceNode")||null;if(n)return a.offset.click.top=-2,a.offset.click.left=16,n.tree.ext.dnd._onDragEvent("start",n,null,r,t,a)},drag:function(r,t){var a,n,o=e(this).data("ui-draggable")||e(this).data("draggable"),d=t.helper.data("ftSourceNode")||null,l=t.helper.data("ftTargetNode")||null,s=e.ui.fancytree.getNode(r.target),i=d&&d.tree.options.dnd;if(r.target&&!s&&e(r.target).closest("div.fancytree-drag-helper,#fancytree-drop-marker").length>0)return n=d||l||e.ui.fancytree,void n.debug("Drag event over helper: ignored.");t.helper.data("ftTargetNode",s),i&&i.updateHelper&&(a=d.tree._makeHookContext(d,r,{otherNode:s,ui:t,draggable:o,dropMarker:e("#fancytree-drop-marker")}),i.updateHelper.call(d.tree,d,a)),l&&l!==s&&l.tree.ext.dnd._onDragEvent("leave",l,d,r,t,o),s&&s.tree.options.dnd.dragDrop&&(s===l?s.tree.ext.dnd._onDragEvent("over",s,d,r,t,o):(s.tree.ext.dnd._onDragEvent("enter",s,d,r,t,o),s.tree.ext.dnd._onDragEvent("over",s,d,r,t,o)))},stop:function(r,t){var a,n=e(this).data("ui-draggable")||e(this).data("draggable"),o=t.helper.data("ftSourceNode")||null,d=t.helper.data("ftTargetNode")||null,l="mouseup"===r.type&&1===r.which;l||(a=o||d||e.ui.fancytree,a.debug("Drag was cancelled")),d&&(l&&d.tree.ext.dnd._onDragEvent("drop",d,o,r,t,n),d.tree.ext.dnd._onDragEvent("leave",d,o,r,t,n)),o&&o.tree.ext.dnd._onDragEvent("stop",o,null,r,t,n)}}),l=!0)}function d(r){var t=r.options.dnd||null,a=r.options.glyph||null;t&&o(),t&&t.dragStart&&r.widget.element.draggable(e.extend({addClasses:!1,appendTo:r.$container,containment:!1,delay:0,distance:4,revert:!1,scroll:!0,scrollSpeed:7,scrollSensitivity:10,connectToFancytree:!0,helper:function(r){var t,n,o,d=e.ui.fancytree.getNode(r.target);return d?(o=d.tree.options.dnd,n=e(d.span),t=e("<div class='fancytree-drag-helper'><span class='fancytree-drag-helper-img' /></div>").css({zIndex:3,position:"relative"}).append(n.find("span.fancytree-title").clone()),t.data("ftSourceNode",d),a&&t.find(".fancytree-drag-helper-img").addClass(a.map.dragHelper),o.initHelper&&o.initHelper.call(d.tree,d,{node:d,tree:d.tree,originalEvent:r,ui:{helper:t}}),t):"<div>ERROR?: helper requested but sourceNode not found</div>"},start:function(e,r){return!!r.helper.data("ftSourceNode")}},r.options.dnd.draggable)),t&&t.dragDrop&&r.widget.element.droppable(e.extend({addClasses:!1,tolerance:"intersect",greedy:!1},r.options.dnd.droppable))}var l=!1;e.ui.fancytree.registerExtension({name:"dnd",version:"@VERSION",options:{autoExpandMS:1e3,draggable:null,droppable:null,focusOnClick:!1,preventVoidMoves:!0,preventRecursiveMoves:!0,smartRevert:!0,dropMarkerOffsetX:-24,dropMarkerInsertOffsetX:-16,dragStart:null,dragStop:null,initHelper:null,updateHelper:null,dragEnter:null,dragOver:null,dragExpand:null,dragDrop:null,dragLeave:null},treeInit:function(r){var t=r.tree;this._superApply(arguments),t.options.dnd.dragStart&&t.$container.on("mousedown",function(t){if(r.options.dnd.focusOnClick){var a=e.ui.fancytree.getNode(t);a&&a.debug("Re-enable focus that was prevented by jQuery UI draggable."),setTimeout(function(){e(t.target).closest(":tabbable").focus()},10)}}),d(t)},_setDndStatus:function(r,t,a,o,d){var l,s="center",i=this._local,p=this.options.dnd,g=this.options.glyph,c=r?e(r.span):null,f=e(t.span),u=f.find("span.fancytree-title");if(i.$dropMarker||(i.$dropMarker=e("<div id='fancytree-drop-marker'></div>").hide().css({"z-index":1e3}).prependTo(e(this.$div).parent()),g&&i.$dropMarker.addClass(g.map.dropMarker)),"after"===o||"before"===o||"over"===o){switch(l=p.dropMarkerOffsetX||0,o){case"before":s="top",l+=p.dropMarkerInsertOffsetX||0;break;case"after":s="bottom",l+=p.dropMarkerInsertOffsetX||0}i.$dropMarker.toggleClass("fancytree-drop-after","after"===o).toggleClass("fancytree-drop-over","over"===o).toggleClass("fancytree-drop-before","before"===o).show().position(e.ui.fancytree.fixPositionOptions({my:"left"+n(l)+" center",at:"left "+s,of:u}))}else i.$dropMarker.hide();c&&c.toggleClass("fancytree-drop-accept",!0===d).toggleClass("fancytree-drop-reject",!1===d),f.toggleClass("fancytree-drop-target","after"===o||"before"===o||"over"===o).toggleClass("fancytree-drop-after","after"===o).toggleClass("fancytree-drop-before","before"===o).toggleClass("fancytree-drop-accept",!0===d).toggleClass("fancytree-drop-reject",!1===d),a.toggleClass("fancytree-drop-accept",!0===d).toggleClass("fancytree-drop-reject",!1===d)},_onDragEvent:function(r,a,n,o,d,l){var s,i,p,g,c,f,u,v,h,y=this.options,b=y.dnd,k=this._makeHookContext(a,o,{otherNode:n,ui:d,draggable:l}),x=null,m=this,C=e(a.span);switch(b.smartRevert&&(l.options.revert="invalid"),r){case"start":a.isStatusNode()?x=!1:b.dragStart&&(x=b.dragStart(a,k)),!1===x?(this.debug("tree.dragStart() cancelled"),d.helper.trigger("mouseup").hide()):(b.smartRevert&&(g=a[k.tree.nodeContainerAttrName].getBoundingClientRect(),p=e(l.options.appendTo)[0].getBoundingClientRect(),l.originalPosition.left=Math.max(0,g.left-p.left),l.originalPosition.top=Math.max(0,g.top-p.top)),C.addClass("fancytree-drag-source"),e(t).on("keydown.fancytree-dnd,mousedown.fancytree-dnd",function(r){"keydown"===r.type&&r.which===e.ui.keyCode.ESCAPE?m.ext.dnd._cancelDrag():"mousedown"===r.type&&m.ext.dnd._cancelDrag()}));break;case"enter":h=(!b.preventRecursiveMoves||!a.isDescendantOf(n))&&(b.dragEnter?b.dragEnter(a,k):null),x=!!h&&(e.isArray(h)?{over:e.inArray("over",h)>=0,before:e.inArray("before",h)>=0,after:e.inArray("after",h)>=0}:{over:!0===h||"over"===h,before:!0===h||"before"===h,after:!0===h||"after"===h}),d.helper.data("enterResponse",x);break;case"over":u=d.helper.data("enterResponse"),v=null,!1===u||("string"==typeof u?v=u:(i=C.offset(),c={x:o.pageX-i.left,y:o.pageY-i.top},f={x:c.x/C.width(),y:c.y/C.height()},u.after&&f.y>.75?v="after":!u.over&&u.after&&f.y>.5?v="after":u.before&&f.y<=.25?v="before":!u.over&&u.before&&f.y<=.5?v="before":u.over&&(v="over"),b.preventVoidMoves&&(a===n?(this.debug("    drop over source node prevented"),v=null):"before"===v&&n&&a===n.getNextSibling()?(this.debug("    drop after source node prevented"),v=null):"after"===v&&n&&a===n.getPrevSibling()?(this.debug("    drop before source node prevented"),v=null):"over"===v&&n&&n.parent===a&&n.isLastSibling()&&(this.debug("    drop last child over own parent prevented"),v=null)),d.helper.data("hitMode",v))),"before"===v||"after"===v||!b.autoExpandMS||!1===a.hasChildren()||a.expanded||b.dragExpand&&!1===b.dragExpand(a,k)||a.scheduleAction("expand",b.autoExpandMS),v&&b.dragOver&&(k.hitMode=v,x=b.dragOver(a,k)),s=!1!==x&&null!==v,b.smartRevert&&(l.options.revert=!s),this._local._setDndStatus(n,a,d.helper,v,s);break;case"drop":v=d.helper.data("hitMode"),v&&b.dragDrop&&(k.hitMode=v,b.dragDrop(a,k));break;case"leave":a.scheduleAction("cancel"),d.helper.data("enterResponse",null),d.helper.data("hitMode",null),this._local._setDndStatus(n,a,d.helper,"out",void 0),b.dragLeave&&b.dragLeave(a,k);break;case"stop":C.removeClass("fancytree-drag-source"),e(t).off(".fancytree-dnd"),b.dragStop&&b.dragStop(a,k);break;default:e.error("Unsupported drag event: "+r)}return x},_cancelDrag:function(){var r=e.ui.ddmanager.current;r&&r.cancel()}})}(jQuery,window,document);